-- è‡ªå®šä¹‰é€»è¾‘æ‰§è¡Œè„šæœ¬ | æ”¯æŒæ‹–åŠ¨ + æ–‡æœ¬æ¡†è¾“å…¥é€»è¾‘
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer

-- åˆ›å»º UI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "CustomLogicGUI"
screenGui.Parent = player:WaitForChild("PlayerGui")
screenGui.ResetOnSpawn = false

-- ä¸»æ¡†ï¼ˆå¯æ‹–åŠ¨ï¼‰
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 420, 0, 320)
mainFrame.Position = UDim2.new(0.5, -210, 0.5, -160)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BackgroundTransparency = 0.1
mainFrame.Parent = screenGui

local frameCorner = Instance.new("UICorner")
frameCorner.CornerRadius = UDim.new(0, 15)
frameCorner.Parent = mainFrame

-- æ ‡é¢˜æ ï¼ˆç”¨äºæ›´å¥½æ‹–åŠ¨ä½“éªŒï¼‰
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 50)
titleBar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
titleBar.Parent = mainFrame

local titleBarCorner = Instance.new("UICorner")
titleBarCorner.CornerRadius = UDim.new(0, 15)
titleBarCorner.Parent = titleBar

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -100, 1, 0)
title.Position = UDim2.new(0, 10, 0, 0)
title.Text = "é€»è¾‘æ‰§è¡Œå™¨"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.BackgroundTransparency = 1
title.TextScaled = true
title.Font = Enum.Font.GothamBold
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = titleBar

-- è¾“å…¥é€»è¾‘çš„æ–‡æœ¬æ¡†ï¼ˆå¤šè¡Œï¼‰
local logicBox = Instance.new("TextBox")
logicBox.Size = UDim2.new(1, -20, 1, -120)
logicBox.Position = UDim2.new(0, 10, 0, 60)
logicBox.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
logicBox.TextColor3 = Color3.fromRGB(200, 255, 200)
logicBox.Text = "-- åœ¨è¿™é‡Œè¾“å…¥ä½ çš„é€»è¾‘ä»£ç \n-- ä¾‹å¦‚ï¼š\n-- local slapRemote = game:GetService(\"ReplicatedStorage\").Remotes.Slap\n-- slapRemote:FireServer(\"MARKER\", workspace.SomePart.CFrame, \"Slap\")"
logicBox.MultiLine = true
logicBox.TextXAlignment = Enum.TextXAlignment.Left
logicBox.TextYAlignment = Enum.TextYAlignment.Top
logicBox.ClearTextOnFocus = false
logicBox.TextScaled = false
logicBox.Font = Enum.Font.SourceSans
logicBox.TextSize = 16
logicBox.Parent = mainFrame

local boxCorner = Instance.new("UICorner")
boxCorner.CornerRadius = UDim.new(0, 8)
boxCorner.Parent = logicBox

-- å¼€å…³æŒ‰é’®
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(1, -20, 0, 50)
toggleButton.Position = UDim2.new(0, 10, 1, -60)
toggleButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
toggleButton.Text = "ğŸ”´ å…³é—­çŠ¶æ€"
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.TextScaled = true
toggleButton.Font = Enum.Font.GothamBold
toggleButton.Parent = mainFrame

local buttonCorner = Instance.new("UICorner")
buttonCorner.CornerRadius = UDim.new(0, 12)
buttonCorner.Parent = toggleButton

-- ==================== æ‹–åŠ¨åŠŸèƒ½ ====================
local dragging = false
local dragInput
local dragStart
local startPos

local function updateInput(input)
    local delta = input.Position - dragStart
    mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

titleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

titleBar.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input == dragInput then
        updateInput(input)
    end
end)
-- ===============================================

-- çŠ¶æ€å˜é‡
local enabled = false
local connection

-- æ‰§è¡Œç”¨æˆ·è¾“å…¥çš„é€»è¾‘
local function RunUserLogic()
    local code = logicBox.Text
    if code == "" or code:match("^%s*$") then return end

    local func, err = loadstring(code)
    if func then
        pcall(func)
    else
        StarterGui:SetCore("SendNotification", {
            Title = "é€»è¾‘é”™è¯¯",
            Text = "ä»£ç æœ‰è¯¯ï¼š" .. tostring(err),
            Duration = 5
        })
    end
end

-- è‡ªåŠ¨å¾ªç¯
local function StartLoop()
    if connection then connection:Disconnect() end
    connection = RunService.Heartbeat:Connect(function()
        if enabled then
            RunUserLogic()
        end
    end)
end

-- æŒ‰é’®ç‚¹å‡»
toggleButton.MouseButton1Click:Connect(function()
    enabled = not enabled
    if enabled then
        toggleButton.Text = "ğŸŸ¢ è¿è¡Œä¸­"
        toggleButton.BackgroundColor3 = Color3.fromRGB(50, 255, 50)
        RunUserLogic()
        StartLoop()
        StarterGui:SetCore("SendNotification", {Title = "å¯åŠ¨", Text = "è‡ªå®šä¹‰é€»è¾‘å¼€å§‹è¿è¡Œï¼", Duration = 3})
    else
        toggleButton.Text = "ğŸ”´ å…³é—­çŠ¶æ€"
        toggleButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        if connection then connection:Disconnect() end
        StarterGui:SetCore("SendNotification", {Title = "åœæ­¢", Text = "è‡ªå®šä¹‰é€»è¾‘å·²åœæ­¢ï¼", Duration = 3})
    end
end)

-- åˆå§‹åŒ–
StarterGui:SetCore("SendNotification", {
    Title = "è‡ªå®šä¹‰é€»è¾‘è„šæœ¬",
    Text = "åœ¨æ–‡æœ¬æ¡†è¾“å…¥ä»£ç ï¼Œç‚¹å‡»æŒ‰é’®å¼€å¯/å…³é—­æ‰§è¡Œã€‚æ•´ä¸ªçª—å£å¯æ‹–åŠ¨ã€‚",
    Duration = 6
})