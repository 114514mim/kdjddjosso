local player = game.Players.LocalPlayer

local function getSyncTool()
    local tool
    for _, v in pairs(player:GetDescendants()) do
        if v.Name == "SyncAPI" then
            tool = v.Parent
            break
        end
    end
    if not tool then
        for _, v in pairs(game.ReplicatedStorage:GetDescendants()) do
            if v.Name == "SyncAPI" then
                tool = v.Parent
                break
            end
        end
    end
    return tool
end

local function runSync(args)
    local tool = getSyncTool()
    if tool and tool.SyncAPI and tool.SyncAPI.ServerEndpoint then
        tool.SyncAPI.ServerEndpoint:InvokeServer(unpack(args))
    end
end

local function SetAnchor(part, boolean)
    runSync({"SyncAnchor", { { ["Part"] = part, ["Anchored"] = boolean } }})
end

local function CreatePart(cf, parent)
    runSync({"CreatePart", "Normal", cf, parent})
end

local function AddMesh(part)
    runSync({"CreateMeshes", { { ["Part"] = part } }})
end

local function SetMesh(part, meshid)
    runSync({"SyncMesh", { { ["Part"] = part, ["MeshId"] = "rbxassetid://" .. meshid } }})
end

local function SetTexture(part, texid)
    runSync({"SyncMesh", { { ["Part"] = part, ["TextureId"] = "rbxassetid://" .. texid } }})
end

local function MeshResize(part, size)
    runSync({"SyncMesh", { { ["Part"] = part, ["Scale"] = size } }})
end

local function Sky(id)
    local char = player.Character or player.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart")
    local cf = hrp.CFrame
    
    local xPos = math.floor(cf.X)
    local yPos = math.floor(cf.Y)
    local zPos = math.floor(cf.Z)
    local pos = CFrame.new(xPos, yPos + 6, zPos)

    local existingSky = nil
    for _, v in pairs(workspace:GetDescendants()) do
        if v.Name == "Skybox" and v:IsA("BasePart") then
            existingSky = v
            break
        end
    end

    if existingSky then
        SetTexture(existingSky, id)
    else
        CreatePart(pos, workspace)
        task.wait(0.1)

        local newPart = nil
        local maxDistance = 5

        for _, v in pairs(workspace:GetDescendants()) do
            if v:IsA("BasePart") and v.Parent == workspace then
                local distance = (v.Position - pos.Position).Magnitude
                if distance < maxDistance and v.Name ~= "MiniToad" then
                    newPart = v
                    break
                end
            end
        end

        if newPart then
            SetAnchor(newPart, true)
            AddMesh(newPart)
            SetMesh(newPart, "111891702759441")
            SetTexture(newPart, id)
            MeshResize(newPart, Vector3.new(2000, 2000, 2000))
        end
    end
end

task.spawn(function()
    if not player.Character then
        player.CharacterAdded:Wait()
    end
    task.wait(0.5)
    Sky("77735500193276")
end)